<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dobby Travel Assistant</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    h1 { text-align: center; color: #6366f1; }
    .chat {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 70vh;
      overflow-y: auto;
      padding: 10px;
    }
    .message { padding: 12px 16px; border-radius: 10px; max-width: 70%; }
    .user { align-self: flex-end; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
    .assistant { align-self: flex-start; background: #334155; color: #f1f5f9; }
    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    textarea {
      flex: 1;
      border-radius: 8px;
      border: none;
      padding: 12px;
      background: #1e293b;
      color: white;
      resize: none;
      height: 50px;
    }
    button {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
    }
    .place-card {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 10px;
      padding: 10px;
      margin: 8px 0;
    }
    .place-card a { color: #60a5fa; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚òï Dobby Travel Assistant</h1>
    <div class="chat" id="chat">
      <div class="message assistant">
        <b>Welcome to Dobby!</b><br>
        Ask me about places to eat, drink, or visit.<br>
        Example: <i>‚ÄúFind coffee near me‚Äù</i> or <i>‚ÄúBest pizza in Cairo‚Äù</i>.<br>
        I can use your location if you allow it!
      </div>
    </div>

    <div class="input-area">
      <textarea id="input" placeholder="Ask Dobby about places..."></textarea>
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const GEO_KEY = "5b4260b421284bbd8f5e10b656279436";
    let userCoords = null;

    // try to get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        console.log("Location:", userCoords);
      });
    }

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");

    function addMessage(text, sender = "assistant", html = false) {
      const msg = document.createElement("div");
      msg.className = `message ${sender}`;
      msg.innerHTML = html ? text : text.replace(/\n/g, "<br>");
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      addMessage(text, "user");
      input.value = "";
      handleUserMessage(text);
    }

    async function handleUserMessage(text) {
      const lower = text.toLowerCase();
      const placeKeywords = ["restaurant", "food", "coffee", "cafe", "bar", "pizza", "museum", "park", "attraction", "beach", "pub"];
      const intentMatch = placeKeywords.some(k => lower.includes(k));

      if (intentMatch) {
        await searchPlaces(text);
      } else {
        addMessage("I'm thinking... (AI analysis)", "assistant");
        const resp = await getDobbyResponse(text);
        addMessage(resp, "assistant");
      }
    }

    function getCategory(text) {
      const t = text.toLowerCase();
      if (t.includes("coffee") || t.includes("cafe")) return "catering.cafe";
      if (t.includes("pizza") || t.includes("restaurant") || t.includes("food")) return "catering.restaurant";
      if (t.includes("bar") || t.includes("pub")) return "catering.bar";
      if (t.includes("museum")) return "entertainment.museum";
      if (t.includes("park")) return "leisure.park";
      if (t.includes("beach")) return "natural.beach";
      if (t.includes("attraction") || t.includes("tourist")) return "tourism.attraction";
      return "catering.restaurant";
    }

    async function searchPlaces(query) {
      addMessage("üîç Searching places for you...", "assistant");
      const category = getCategory(query);
      let url = `https://api.geoapify.com/v2/places?categories=${category}&limit=6&apiKey=${GEO_KEY}`;

      if (userCoords) {
        url += `&filter=circle:${userCoords.lon},${userCoords.lat},5000&bias=proximity:${userCoords.lon},${userCoords.lat}`;
      }

      const resp = await fetch(url);
      const data = await resp.json();
      if (!data.features || !data.features.length) {
        addMessage("No places found. Try another query or city.", "assistant");
        return;
      }

      addMessage(`Here are some results for "${query}":`, "assistant");
      data.features.forEach(f => {
        const p = f.properties;
        const html = `
          <div class="place-card">
            <b>${p.name || "Unknown"}</b><br>
            ${p.address_line2 || p.formatted || "Address not available"}<br>
            <a href="https://maps.google.com/?q=${encodeURIComponent(p.name || "")}" target="_blank">View on map</a>
          </div>`;
        addMessage(html, "assistant", true);
      });
    }

    async function getDobbyResponse(text) {
      try {
        const response = await fetch("https://api.fireworks.ai/inference/v1/completions", {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "Authorization": "Bearer fw_3ZVw4csVhBzeyBqkw6NAt1jd"
          },
          body: JSON.stringify({
            model: "accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b",
            prompt: `You are Dobby, a friendly travel assistant. Reply in clear English to: ${text}`,
            max_tokens: 300,
            temperature: 0.7
          })
        });
        const data = await response.json();
        return data.choices?.[0]?.text?.trim() || "Sorry, I didn‚Äôt understand that.";
      } catch (e) {
        return "Error contacting Dobby API.";
      }
    }
  </script>
</body>
</html>
