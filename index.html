<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dobby Travel Assistant</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="dobby-logo.png">
  <style>
    /* ÙƒÙ„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± */
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border: #334155;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --glow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    * {margin:0;padding:0;box-sizing:border-box;}
    body {
      font-family:'Inter',sans-serif;background:var(--bg-primary);
      color:var(--text-primary);overflow-x:hidden;
    }
    /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ */
  </style>
</head>
<body>
  <!-- Ù†ÙØ³ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØªÙ…Ø§Ù…Ù‹Ø§ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
  <!-- ... (ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©) ... -->

  <script type="module">
    const CONFIG = {
      GEOAPIFY_KEY: "5b4260b421284bbd8f5e10b656279436",
      DOBBY_KEY: "fw_3ZVw4csVhBzeyBqkw6NAt1jd",
      MAX_PLACES: 6,
      MAX_TOKENS: 450
    };

    const state = { userCoords: null, waitingForLocation:false, lastDetectedIntent:null, ...{} };
    const elements = {
      chatMessages: document.getElementById('chatMessages'),
      messageInput: document.getElementById('messageInput'),
      sendButton: document.getElementById('sendButton'),
      placesFoundStat: document.getElementById('placesFound'),
      queriesStat: document.getElementById('queriesAnswered'),
      messagesStat: document.getElementById('messagesExchanged'),
      recommendationsStat: document.getElementById('recommendationsMade'),
      recentSearches: document.getElementById('recentSearches')
    };

    document.addEventListener('DOMContentLoaded', init);

    function init() {
      setupEventListeners();
      autoResizeTextarea();
      loadRecentSearches();
      tryGetGeolocation();
    }

    function setupEventListeners() {
      elements.messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });
      elements.messageInput.addEventListener('input', autoResizeTextarea);
    }

    function autoResizeTextarea() {
      const t = elements.messageInput;
      t.style.height = 'auto';
      t.style.height = Math.min(t.scrollHeight, 120)+'px';
    }

    function tryGetGeolocation() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos=>{
        state.userCoords={lat:pos.coords.latitude,lon:pos.coords.longitude};
        console.log('User location:',state.userCoords);
      },err=>console.warn('Geolocation denied',err));
    }

    async function sendMessage() {
      const raw = elements.messageInput.value.trim();
      if(!raw) return;
      addMessage(raw,'user');
      elements.messageInput.value=''; autoResizeTextarea();

      const lower = raw.toLowerCase();
      const keywords=['restaurant','coffee','cafe','bar','pizza','attraction','museum','park','beach'];
      const hasPlaceIntent=keywords.some(k=>lower.includes(k));
      const city=extractLocationFromText(raw);

      if(hasPlaceIntent){
        if((lower.includes('near me')||lower.includes('nearby')) && state.userCoords){
          await handlePlaceSearch(raw,state.userCoords);
        }else if(city){
          await handlePlaceSearch(raw,null,city);
        }else if(state.userCoords){
          await handlePlaceSearch(raw,state.userCoords);
        }else{
          state.waitingForLocation=true;
          state.lastDetectedIntent=raw;
          addMessage("Please allow location access or type a city name (e.g., 'Cairo').",'assistant');
        }
        return;
      }

      showTypingIndicator();
      const resp=await getDobbyResponse(raw,{role:'travel_assistant'});
      hideTypingIndicator();
      addMessage(resp,'assistant',null,true);
    }

    function extractLocationFromText(t){
      const m=t.match(/\b(?:in|at)\s+([A-Za-z\u00C0-\u017F\s\-]+)/i);
      if(m) return m[1].trim();
      const parts=t.split(',');
      return parts.length>=2?parts.pop().trim():null;
    }

    /* ğŸ”§ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø¹Ø¯Ù‘Ù„ */
    async function handlePlaceSearch(originalQuery, coords=null, city=null){
      try{
        showTypingIndicator('Searching places for you...');
        const searchText=derivePlaceText(originalQuery);
        let url='';
        if(coords){
          url=`https://api.geoapify.com/v2/places?categories=catering.restaurant,catering.cafe,catering.fast_food,catering.bar&filter=circle:${coords.lon},${coords.lat},5000&limit=${CONFIG.MAX_PLACES}&apiKey=${CONFIG.GEOAPIFY_KEY}`;
        }else if(city){
          url=`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(searchText+' in '+city)}&limit=${CONFIG.MAX_PLACES}&apiKey=${CONFIG.GEOAPIFY_KEY}`;
        }else{
          throw new Error("No location or city specified for search.");
        }

        const resp=await fetch(url);
        if(!resp.ok) throw new Error(`Geoapify error: ${resp.status}`);
        const data=await resp.json();
        const features=data.features||[];
        const places=features.map(f=>{
          const p=f.properties||{};
          return {
            name:p.name||p.formatted||'Unknown',
            address:p.formatted||'Address not available',
            lat:p.lat||p.geometry?.coordinates?.[1],
            lon:p.lon||p.geometry?.coordinates?.[0],
            category:(p.categories&&p.categories[0])||'place',
            url:`https://maps.geoapify.com/v1/staticmap?style=osm-bright-smooth&width=600&height=400&center=lonlat:${p.lon||p.geometry?.coordinates?.[0]},${p.lat||p.geometry?.coordinates?.[1]}&zoom=15&marker=lonlat:${p.lon||p.geometry?.coordinates?.[0]},${p.lat||p.geometry?.coordinates?.[1]};color:%23bb3f73;size:medium;icon:marker&apiKey=${CONFIG.GEOAPIFY_KEY}`
          };
        });

        hideTypingIndicator();
        if(!places.length){
          addMessage(`I couldn't find places for "${originalQuery}". Try another search.`,'assistant','error-message');
          return;
        }

        addMessage(`Found ${places.length} results for "${searchText}":`,'assistant',null,true);
        places.forEach(p=>addMessage(createPlaceCard(p),'assistant',null,true));

        showTypingIndicator('Preparing recommendations...');
        const dobbyPrompt=`User query: "${originalQuery}"\nPlaces:\n${places.map((p,i)=>`${i+1}. ${p.name} â€” ${p.address}`).join('\n')}`;
        const dobbyResp=await getDobbyResponse(dobbyPrompt,{role:'travel_assistant'});
        hideTypingIndicator();
        addMessage(`<div class="strategy-card"><div class="strategy-title"><i class="fas fa-star"></i> Top Recommendations</div><div class="strategy-content">${formatDobbyResponse(dobbyResp)}</div></div>`,'assistant',null,true);

      }catch(err){
        hideTypingIndicator();
        addMessage(`Error fetching places: ${err.message}`,'assistant','error-message');
      }
    }

    function derivePlaceText(t){
      const k=['coffee','cafe','restaurant','pizza','bar','museum','park','beach'];
      const l=t.toLowerCase();
      for(const x of k){if(l.includes(x))return x;}
      return t;
    }

    /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„: createPlaceCard, getDobbyResponse, addMessage, showTypingIndicator... ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ */
  </script>
</body>
</html>
